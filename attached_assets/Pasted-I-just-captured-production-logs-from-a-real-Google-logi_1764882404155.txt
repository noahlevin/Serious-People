I just captured production logs from a real Google login attempt. The relevant part:

9:01:32 PM [express] GET /api/auth/google/callback 500 in 202ms :: {"message":"Unexpected server response: 404"}
Error: Unexpected server response: 404
  at async yd._verify (/home/runner/workspace/dist/index.cjs:117:76630)
  at async Tw.upsertUser (/home/runner/workspace/dist/index.cjs:117:74529)
  at async H0.execute (/home/runner/workspace/dist/index.cjs:117:71301)
  at async TZ (/home/runner/workspace/dist/index.cjs:117:75563)


This tells us:

The /api/auth/google/callback route is hit.

The Passport Google strategy calls a verify function (_verify).

Inside that verify function, our upsertUser helper throws Error: Unexpected server response: 404.

I need you to debug upsertUser and its downstream call, not the route itself.

Tasks

Locate upsertUser in the source code

Find the original (non-bundled) implementation of upsertUser that corresponds to Tw.upsertUser in dist/index.cjs.

Show me the function and identify:

What external service or client it calls (DB, API, WebSocket, etc.).

Any URL / endpoint / baseURL / WebSocket URL it uses.

Any relevant environment variables (e.g. *_URL, *_ENDPOINT, DATABASE_URL, WS_URL, etc.).

Instrument upsertUser with detailed logging

Wrap the remote call in a try/catch and log:

Start of upsertUser with key fields (e.g. Google user ID, email).

The target URL / endpoint or client config (without secrets).

On error:

err.name

err.message

err.stack

err.response?.status and err.response?.data if present

Any other fields that look relevant.

Rebuild so these logs appear in production.

Check for obvious endpoint / env misconfig

Based on the upsertUser implementation:

Confirm that any URL or endpoint it calls is valid in production.

Confirm that all required env vars are set in the Deploy / production environment, not just in the main repl.

If you see anything that would cause a 404 from the remote service (wrong path, missing /api, wrong region, missing project ID, etc.), fix it and explain the change.

Explain the likely cause

In a short summary, answer:

What external service is upsertUser calling?

Why would that service return 404 in production during the Google callback?

What did you change (code or config) to fix it?

Stop after youâ€™ve:

Added the logging,

Fixed any obvious config/URL issue, and

Described exactly what you changed and where.

I will then redeploy, do another Google login, and share the new logs if the error persists.
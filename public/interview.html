<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Serious People – Interview</title>
  <meta name="description" content="Start your career coaching interview with Serious People.">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500&family=Source+Serif+4:ital,opsz,wght@0,8..60,400;0,8..60,500;0,8..60,600;1,8..60,400;1,8..60,500&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Source Serif 4', Georgia, 'Times New Roman', serif;
      background: #faf9f6;
      color: #1a1a1a;
      line-height: 1.6;
      height: 100vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 100;
      background: #faf9f6;
      border-bottom: 1px solid #d4d4d4;
      padding: 0.75rem 2rem;
      flex-shrink: 0;
    }

    .progress-bar-container {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: transparent;
      overflow: hidden;
    }

    .progress-bar-fill {
      height: 100%;
      width: 0%;
      background: #1a1a1a;
      transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .header-content {
      max-width: 800px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .logo-link {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      text-decoration: none;
    }

    .logo-icon {
      width: 36px;
      height: 36px;
      object-fit: cover;
    }

    .logo {
      font-family: 'Playfair Display', Georgia, serif;
      font-size: 1.125rem;
      font-weight: 700;
      color: #1a1a1a;
      text-transform: uppercase;
      letter-spacing: 0.02em;
    }

    .logo-subtitle {
      font-family: 'Source Serif 4', Georgia, serif;
      font-size: 0.875rem;
      color: #666;
      font-weight: 400;
    }

    main {
      flex: 1;
      display: flex;
      flex-direction: column;
      max-width: 700px;
      width: 100%;
      margin: 0 auto;
      padding: 1.5rem;
      padding-top: calc(60px + 1.5rem);
      padding-bottom: 120px;
      overflow: hidden;
    }

    .chat-window {
      flex: 1;
      overflow-y: auto;
      padding: 1rem 0;
      display: flex;
      flex-direction: column;
      gap: 1.25rem;
      scroll-behavior: smooth;
    }

    .message {
      max-width: 85%;
      padding: 1rem 1.25rem;
      font-size: 1rem;
      line-height: 1.7;
      white-space: pre-wrap;
    }

    .message.assistant {
      align-self: flex-start;
      background: #fff;
      border-left: 3px solid #1a1a1a;
      border-top: 1px solid #e5e5e5;
      border-right: 1px solid #e5e5e5;
      border-bottom: 1px solid #e5e5e5;
    }

    .message.assistant ul,
    .message.assistant ol {
      margin: 0.5rem 0;
      padding-left: 1.5rem;
    }

    .message.assistant li {
      margin-bottom: 0.25rem;
    }

    .message.user {
      align-self: flex-end;
      background: #1a1a1a;
      color: #fff;
      border-left: 3px solid #666;
    }

    .options-container {
      align-self: flex-end;
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      max-width: 85%;
      justify-content: flex-end;
    }

    .option-pill {
      background: #fff;
      border: 1px solid #1a1a1a;
      padding: 0.5rem 1rem;
      font-family: 'Source Serif 4', Georgia, serif;
      font-size: 0.95rem;
      color: #1a1a1a;
      cursor: pointer;
      transition: all 0.15s ease;
      white-space: nowrap;
    }

    .option-pill:hover {
      background: #1a1a1a;
      color: #fff;
    }

    .option-pill:active {
      transform: scale(0.98);
    }

    .options-container.hidden {
      display: none;
    }

    .input-area {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: #faf9f6;
      border-top: 1px solid #d4d4d4;
      padding: 1rem;
      z-index: 100;
    }

    .input-row {
      display: flex;
      align-items: flex-end;
      gap: 0.5rem;
      max-width: 700px;
      margin: 0 auto;
    }

    textarea {
      flex: 1;
      padding: 0.75rem 1rem;
      border: 1px solid #d4d4d4;
      background: #fff;
      font-family: 'Source Serif 4', Georgia, serif;
      font-size: 1rem;
      resize: none;
      min-height: 44px;
      max-height: 150px;
      line-height: 1.5;
      overflow-y: hidden;
    }

    textarea.scrollable {
      overflow-y: auto;
    }

    .typing-indicator {
      align-self: flex-start;
      background: #fff;
      border-left: 3px solid #1a1a1a;
      border-top: 1px solid #e5e5e5;
      border-right: 1px solid #e5e5e5;
      border-bottom: 1px solid #e5e5e5;
      padding: 1rem 1.25rem;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .typing-indicator .dot {
      width: 8px;
      height: 8px;
      background: #666;
      border-radius: 50%;
      animation: typingBounce 1.4s infinite ease-in-out;
    }

    .typing-indicator .dot:nth-child(1) {
      animation-delay: 0s;
    }

    .typing-indicator .dot:nth-child(2) {
      animation-delay: 0.2s;
    }

    .typing-indicator .dot:nth-child(3) {
      animation-delay: 0.4s;
    }

    @keyframes typingBounce {
      0%, 80%, 100% {
        transform: translateY(0);
        opacity: 0.4;
      }
      40% {
        transform: translateY(-6px);
        opacity: 1;
      }
    }

    textarea:focus {
      outline: none;
      border-color: #1a1a1a;
    }

    .send-button {
      background: #1a1a1a;
      color: #fff;
      border: none;
      width: 44px;
      height: 44px;
      font-family: 'Source Serif 4', Georgia, serif;
      font-weight: 500;
      font-size: 1.25rem;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .send-button:hover {
      background: #333;
    }

    .send-button:disabled {
      background: #999;
      cursor: not-allowed;
    }

    .send-button:disabled:hover {
      background: #999;
    }

    .status-line {
      text-align: center;
      font-size: 0.8rem;
      color: #666;
      padding: 0.25rem 0 0;
      min-height: 1.5rem;
      font-style: italic;
      max-width: 700px;
      margin: 0 auto;
    }

    .paywall-inline {
      width: 100%;
      display: flex;
      justify-content: flex-start;
      margin-top: 1rem;
      padding-bottom: 2rem;
    }

    .paywall-card {
      background: #fff;
      border: 2px solid #1a1a1a;
      padding: 1.5rem 2rem;
      text-align: center;
      max-width: 480px;
    }

    .paywall-card h3 {
      font-family: 'Playfair Display', Georgia, serif;
      font-size: 1.25rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: #1a1a1a;
    }

    .paywall-card > p {
      font-family: 'Source Serif 4', Georgia, serif;
      color: #444;
      margin-bottom: 1rem;
      font-size: 0.95rem;
      line-height: 1.5;
    }

    #reasons {
      text-align: left;
      margin-bottom: 1.5rem;
      border-top: 1px solid #e5e5e5;
      padding-top: 1rem;
    }

    #reasons .intro {
      font-family: 'Playfair Display', Georgia, serif;
      font-weight: 600;
      color: #1a1a1a;
      margin-bottom: 0.75rem;
      font-size: 0.95rem;
    }

    #reasons ul {
      list-style: none;
      padding: 0;
    }

    #reasons li {
      padding: 0.625rem 0;
      padding-left: 1.5rem;
      position: relative;
      font-size: 0.95rem;
      color: #444;
      border-bottom: 1px solid #f0f0f0;
      line-height: 1.5;
    }

    #reasons li:last-child {
      border-bottom: none;
    }

    #reasons li::before {
      content: "—";
      position: absolute;
      left: 0;
      color: #1a1a1a;
    }

    .checkout-button {
      background: #1a1a1a;
      color: #fff;
      border: 2px solid #1a1a1a;
      padding: 1rem 2rem;
      font-family: 'Source Serif 4', Georgia, serif;
      font-weight: 500;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.2s;
      width: 100%;
      max-width: 320px;
    }

    .checkout-button:hover {
      background: #fff;
      color: #1a1a1a;
    }

    .checkout-button:disabled {
      background: #999;
      border-color: #999;
      cursor: not-allowed;
    }

    .checkout-button:disabled:hover {
      background: #999;
      color: #fff;
    }

    .price-note {
      margin-top: 1rem;
      font-size: 0.8rem;
      color: #666;
      font-style: italic;
    }

    .spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 0.8s linear infinite;
      margin-right: 8px;
      vertical-align: middle;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    @media (max-width: 640px) {
      header {
        padding: 0.75rem 1rem;
      }

      main {
        padding: 1rem;
        padding-top: calc(60px + 1rem);
        padding-bottom: 100px;
      }

      .message {
        max-width: 90%;
      }

      .input-area {
        padding: 0.75rem;
      }

      .paywall-card {
        padding: 1.25rem;
        max-width: 100%;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="header-content">
      <a href="/" class="logo-link">
        <img src="/logan-roy.png" alt="Serious People" class="logo-icon">
        <span class="logo">Serious People</span>
        <span class="logo-subtitle" id="moduleSubtitle"> · Intro</span>
      </a>
    </div>
    <div class="progress-bar-container">
      <div class="progress-bar-fill" id="progressBar"></div>
    </div>
  </header>

  <main>
    <div class="chat-window" id="chatWindow" data-testid="chat-window">
      <div id="paywall" class="paywall-inline" style="display:none;" data-testid="paywall">
        <div class="paywall-card">
          <h3>Ready to work the plan?</h3>
          <p>
            We've mapped out a custom 3-module coaching session plus your Career Brief.
          </p>
          <div id="reasons"></div>
          <button id="checkoutBtn" class="checkout-button" data-testid="button-checkout">
            Let's Work the Plan – $19
          </button>
          <div class="price-note">
            Payment handled securely via Stripe.
          </div>
        </div>
      </div>
    </div>
  </main>

  <div class="input-area" id="inputArea">
    <div class="input-row">
      <textarea 
        id="userInput" 
        data-testid="input-message"
        placeholder="Type your answer here..."
        rows="1"
      ></textarea>
      <button class="send-button" id="sendBtn" data-testid="button-send">→</button>
    </div>
    <div class="status-line" id="status" data-testid="status-line"></div>
  </div>

  <script>
    const STORAGE_KEY = 'serious_people_transcript';
    const PROGRESS_KEY = 'serious_people_progress';
    let transcript = [];
    let interviewComplete = false;

    const chatWindow = document.getElementById('chatWindow');
    const userInput = document.getElementById('userInput');
    const sendBtn = document.getElementById('sendBtn');
    const status = document.getElementById('status');
    const paywall = document.getElementById('paywall');
    const reasonsDiv = document.getElementById('reasons');
    const checkoutBtn = document.getElementById('checkoutBtn');
    const inputArea = document.getElementById('inputArea');
    const progressBar = document.getElementById('progressBar');
    const moduleSubtitle = document.getElementById('moduleSubtitle');

    let currentProgress = 0;
    let currentModule = 'Intro';
    let moduleJustChanged = false;

    function loadProgress() {
      try {
        const saved = sessionStorage.getItem(PROGRESS_KEY);
        if (saved) {
          const value = parseInt(saved, 10);
          if (!isNaN(value) && value >= 0 && value <= 100) {
            currentProgress = value;
            progressBar.style.width = value + '%';
          }
        }
      } catch (e) {
        console.error('Failed to load progress:', e);
      }
    }

    function saveProgress(value) {
      try {
        sessionStorage.setItem(PROGRESS_KEY, value.toString());
      } catch (e) {
        console.error('Failed to save progress:', e);
      }
    }

    function updateProgress(value, forceReset = false) {
      if (value !== null && value >= 0 && value <= 100) {
        if (forceReset || value >= currentProgress) {
          currentProgress = value;
          progressBar.style.width = value + '%';
          saveProgress(value);
        }
      }
    }

    function detectAndUpdateModule(content) {
      const moduleMatch = content.match(/^—\s*(.+?)\s*\(est\./m);
      if (moduleMatch) {
        const moduleName = moduleMatch[1].trim();
        if (moduleName !== currentModule) {
          currentModule = moduleName;
          moduleSubtitle.textContent = ' · ' + moduleName;
          moduleJustChanged = true;
          updateProgress(5, true);
        }
        return true;
      }
      return false;
    }

    function loadTranscript() {
      try {
        const saved = sessionStorage.getItem(STORAGE_KEY);
        if (saved) {
          transcript = JSON.parse(saved);
          transcript.forEach(msg => {
            if (msg.role === 'assistant') {
              detectAndUpdateModule(msg.content);
            }
            renderMessage(msg.role, msg.content, false);
          });
        }
      } catch (e) {
        console.error('Failed to load transcript:', e);
        transcript = [];
      }
    }

    function saveTranscript() {
      try {
        sessionStorage.setItem(STORAGE_KEY, JSON.stringify(transcript));
      } catch (e) {
        console.error('Failed to save transcript:', e);
      }
    }

    function formatContent(content) {
      let formatted = content
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');
      
      formatted = formatted.replace(/^- (.+)$/gm, '• $1');
      
      formatted = formatted.replace(/\n/g, '<br>');
      
      return formatted;
    }

    function renderMessage(role, content, animate = false, onComplete = null) {
      const div = document.createElement('div');
      div.className = `message ${role}`;
      
      if (role === 'assistant' && animate) {
        typewriterEffect(div, content, onComplete);
      } else {
        div.innerHTML = formatContent(content);
        if (onComplete) onComplete();
      }
      
      chatWindow.appendChild(div);
      chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    function typewriterEffect(element, text, onComplete = null) {
      const formattedText = formatContent(text);
      let index = 0;
      const speed = 12;
      
      function type() {
        if (index < formattedText.length) {
          if (formattedText.substring(index, index + 4) === '<br>') {
            element.innerHTML += '<br>';
            index += 4;
          } else if (formattedText[index] === '&') {
            const semicolonIndex = formattedText.indexOf(';', index);
            if (semicolonIndex !== -1 && semicolonIndex - index < 8) {
              element.innerHTML += formattedText.substring(index, semicolonIndex + 1);
              index = semicolonIndex + 1;
            } else {
              element.innerHTML += formattedText[index];
              index++;
            }
          } else {
            element.innerHTML += formattedText[index];
            index++;
          }
          chatWindow.scrollTop = chatWindow.scrollHeight;
          setTimeout(type, speed);
        } else {
          if (onComplete) onComplete();
        }
      }
      
      type();
    }

    function setStatus(text) {
      status.textContent = text;
    }

    function showTypingIndicator() {
      const indicator = document.createElement('div');
      indicator.className = 'typing-indicator';
      indicator.id = 'typing-indicator';
      indicator.innerHTML = '<div class="dot"></div><div class="dot"></div><div class="dot"></div>';
      chatWindow.appendChild(indicator);
      chatWindow.scrollTop = chatWindow.scrollHeight;
      return indicator;
    }

    function hideTypingIndicator() {
      const indicator = document.getElementById('typing-indicator');
      if (indicator) {
        indicator.remove();
      }
    }

    function randomDelay(min, max) {
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    const TEST_TRANSCRIPT = [
      { role: 'assistant', content: "Hello! I'm here to help you prepare for some important career conversations. Before we write your scripts, I'd like to understand your situation better.\n\nWhat's prompting you to think about a career change right now?" },
      { role: 'user', content: "I've been at my company for 3 years and I feel stuck. My manager keeps promising a promotion but it never happens." },
      { role: 'assistant', content: "Three years is significant, and broken promises around promotion are frustrating. That erodes trust.\n\nWhat role are you in currently, and what's the promotion you've been waiting for?" },
      { role: 'user', content: "I'm a senior software engineer. The promotion would be to staff engineer, which comes with a significant pay bump and more autonomy." },
      { role: 'assistant', content: "Staff engineer is a meaningful step up. The autonomy piece is often as important as the money.\n\nHave you had direct conversations with your manager about specific criteria for the promotion?" },
      { role: 'user', content: "Yes, we've had several. Each time they say I'm 'almost there' but the goalposts keep moving. First it was completing a big project, then it was 'demonstrating leadership,' now it's some vague thing about 'executive presence.'" },
      { role: 'assistant', content: "Moving goalposts are a classic stalling tactic. The shift from concrete deliverables to vague qualities like 'executive presence' is particularly telling.\n\nDo you have a sense of whether this is your manager's decision, or if they're getting blocked from above?" },
      { role: 'user', content: "I think my manager wants to promote me but their boss is the blocker. My skip-level seems to have favorites and I'm not one of them." },
      { role: 'assistant', content: "Politics at the skip level is tough because you have less direct influence there. This context is helpful.\n\nWhat's your financial situation? Could you afford to leave without another job lined up, or do you need to line something up first?" },
      { role: 'user', content: "I have about 6 months of expenses saved. I could leave but I'd rather have something lined up. My partner is supportive but nervous about me quitting without a plan." },
      { role: 'assistant', content: "Six months gives you some runway, and your partner's concern is reasonable. Having a plan matters for both practical and relationship reasons.\n\nWhat does your partner do for work? Understanding your household situation helps me write a better script for that conversation." },
      { role: 'user', content: "She's a teacher. Stable income but not enough to cover all our expenses alone. We have a mortgage and a young kid." },
      { role: 'assistant', content: "Stable but not sufficient on its own—that means you need a plan, not an impulse exit. The mortgage and kid add real stakes.\n\nAre you already job searching, or is that something you'd start after we clarify your strategy?" },
      { role: 'user', content: "I've been casually looking for a few months. Had a few interviews but nothing has clicked yet. I think I'm underselling myself." },
      { role: 'assistant', content: "Underselling yourself is common when you've been overlooked internally—it messes with your sense of your own value.\n\nWhat would an ideal next role look like for you? Same type of work at a better company, or something different?" },
      { role: 'user', content: "Same technical work but at a company with clearer growth paths. I want to make staff engineer within a year or two and eventually move toward engineering management." },
      { role: 'assistant', content: "Clear growth path to staff, eventual move to management—that's a solid trajectory. It's also a compelling story for interviews.\n\nLast question: What's your timeline? When do you want to have made a decision or a move by?" },
      { role: 'user', content: "I'd like to have an offer in hand within the next 3 months. If not, I might need to have a harder conversation with my current company about my future there." },
      { role: 'assistant', content: "Three months to secure an offer, with a fallback plan to have a frank conversation if needed. That's actionable.\n\nI think I have enough to write your scripts now. Ready to see them?" }
    ];

    const TEST_VALUE_BULLETS = `- Address the promotion stall with concrete next steps, not vague promises
- Give your partner confidence with a clear 3-month timeline and financial safety net
- Articulate your staff engineer trajectory to command better offers
- Prepare a diplomatic but firm exit conversation if the job search doesn't pan out`;

    function handleTestBypass() {
      transcript = [...TEST_TRANSCRIPT];
      saveTranscript();
      
      chatWindow.innerHTML = '';
      
      transcript.forEach(msg => {
        renderMessage(msg.role, msg.content, false);
      });
      
      updateProgress(100);
      interviewComplete = true;
      inputArea.style.display = 'none';
      showPaywall(TEST_VALUE_BULLETS);
      setStatus('');
    }

    let currentOptionsContainer = null;

    function renderOptions(options) {
      if (currentOptionsContainer) {
        currentOptionsContainer.remove();
        currentOptionsContainer = null;
      }

      const container = document.createElement('div');
      container.className = 'options-container';
      container.setAttribute('data-testid', 'options-container');

      options.forEach((optionText, index) => {
        const pill = document.createElement('button');
        pill.className = 'option-pill';
        pill.textContent = optionText;
        pill.setAttribute('data-testid', `option-pill-${index}`);
        pill.addEventListener('click', () => selectOption(optionText));
        container.appendChild(pill);
      });

      chatWindow.appendChild(container);
      currentOptionsContainer = container;
      chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    function selectOption(optionText) {
      if (currentOptionsContainer) {
        currentOptionsContainer.remove();
        currentOptionsContainer = null;
      }
      
      userInput.value = '';
      sendMessage(optionText);
    }

    function showPaywall(valueBullets) {
      chatWindow.appendChild(paywall);
      paywall.style.display = 'flex';
      
      if (valueBullets) {
        const lines = valueBullets.trim().split('\n').filter(line => line.trim().startsWith('-'));
        if (lines.length > 0) {
          let html = '<p class="intro">Why these scripts will help:</p><ul>';
          lines.forEach(line => {
            const text = line.replace(/^-\s*/, '').trim();
            if (text) {
              html += `<li>${text}</li>`;
            }
          });
          html += '</ul>';
          reasonsDiv.innerHTML = html;
        }
      }
      
      setTimeout(() => {
        chatWindow.scrollTop = chatWindow.scrollHeight;
      }, 50);
    }

    async function sendMessage(userMessage = null) {
      sendBtn.disabled = true;

      if (userMessage) {
        if (userMessage.toLowerCase() === 'testskip') {
          handleTestBypass();
          sendBtn.disabled = false;
          return;
        }
        
        transcript.push({ role: 'user', content: userMessage });
        saveTranscript();
        renderMessage('user', userMessage);
      }

      showTypingIndicator();
      setStatus('');

      try {
        const response = await fetch('/interview', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ transcript })
        });

        if (!response.ok) {
          throw new Error('Failed to get response');
        }

        const data = await response.json();
        
        const thinkingDelay = randomDelay(800, 2000);
        await new Promise(resolve => setTimeout(resolve, thinkingDelay));
        
        hideTypingIndicator();
        
        detectAndUpdateModule(data.reply);
        
        if (data.progress !== null && data.progress !== undefined) {
          if (moduleJustChanged) {
            moduleJustChanged = false;
          } else {
            updateProgress(data.progress);
          }
        }
        
        transcript.push({ role: 'assistant', content: data.reply });
        saveTranscript();
        
        const hasOptions = data.options && data.options.length > 0;
        
        if (hasOptions) {
          renderMessage('assistant', data.reply, true, () => {
            renderOptions(data.options);
          });
        } else {
          renderMessage('assistant', data.reply, true);
        }

        if (data.done) {
          interviewComplete = true;
          setStatus('');
          inputArea.style.display = 'none';
          showPaywall(data.valueBullets);
        } else {
          setStatus('');
        }
      } catch (error) {
        console.error('Interview error:', error);
        hideTypingIndicator();
        setStatus('Something went wrong. Please try again.');
      } finally {
        sendBtn.disabled = false;
        userInput.focus();
      }
    }

    async function handleCheckout() {
      checkoutBtn.disabled = true;
      checkoutBtn.innerHTML = '<span class="spinner"></span>Redirecting...';

      try {
        const response = await fetch('/checkout', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });

        const data = await response.json();

        if (data.url) {
          window.location.href = data.url;
        } else {
          throw new Error(data.error || 'Failed to create checkout session');
        }
      } catch (error) {
        console.error('Checkout error:', error);
        alert('Something went wrong. Please try again.');
        checkoutBtn.disabled = false;
        checkoutBtn.innerHTML = 'Let\'s Work the Plan – $19';
      }
    }

    function autoResize() {
      userInput.style.height = 'auto';
      const newHeight = Math.min(userInput.scrollHeight, 150);
      userInput.style.height = newHeight + 'px';
      
      if (userInput.scrollHeight > 150) {
        userInput.classList.add('scrollable');
      } else {
        userInput.classList.remove('scrollable');
      }
    }

    function clearOptionsAndSend(text) {
      if (currentOptionsContainer) {
        currentOptionsContainer.remove();
        currentOptionsContainer = null;
      }
      sendMessage(text);
    }

    sendBtn.addEventListener('click', () => {
      const text = userInput.value.trim();
      if (text) {
        userInput.value = '';
        autoResize();
        clearOptionsAndSend(text);
      }
    });

    userInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        const text = userInput.value.trim();
        if (text) {
          userInput.value = '';
          autoResize();
          clearOptionsAndSend(text);
        }
      }
    });

    userInput.addEventListener('input', autoResize);

    checkoutBtn.addEventListener('click', handleCheckout);

    loadTranscript();
    loadProgress();

    if (transcript.length === 0) {
      sendMessage();
    } else {
      const lastResponse = transcript.filter(t => t.role === 'assistant').pop();
      if (lastResponse && lastResponse.content.includes('I think I have enough')) {
        interviewComplete = true;
        inputArea.style.display = 'none';
        showPaywall(null);
      } else {
        setStatus('');
      }
    }
  </script>
</body>
</html>
